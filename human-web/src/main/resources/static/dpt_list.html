<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>人事考核管理系统</title>
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<link rel="stylesheet" href="./css/xadmin.css">
<link rel="stylesheet" href="./css/font.css">
<link rel="stylesheet"
	href="./lib/layui/css/modules/layer/default/layer.css">
<script type="text/javascript" src="./js/jquery-1.8.3.min.js"></script>
<script type="text/javascript" src="./js/vue.min.js"></script>
<script type="text/javascript" src="./lib/layui/layui.js"></script>
<script src="./lib/layui/layui.js" charset="utf-8"></script>
<script type="text/javascript" src="./js/xadmin.js"></script>
<style type="text/css">
	#mask {
		background: rgba(0, 0, 0, .5);
		width: 100%;
		height: 100%;
		position: fixed;
		z-index: 999;
		top: 0;
		left: 0;
	}
	
	.mask {
		width: 500px;
		height: 500px;
		background: rgba(255, 255, 255, 1);
		position: absolute;
		left: 0;
		top: 0;
		right: 0;
		bottom: 0;
		margin: auto;
		z-index: 47;
		border-radius: 5px;
	}
	
	.title {
		padding: 10px;
		border-bottom: 1px solid #eee;
	}
	
	.title span {
		float: right;
		cursor: pointer;
	}
</style>
</head>
<body>
	<div class="x-nav">
		<span class="layui-breadcrumb"> <a href="javascript:;">首页</a>
			<a href="javascript:;">部门管理</a> <a> <cite>部门列表</cite></a>
		</span> 
		<a class="layui-btn layui-btn-small" style="line-height: 1.6em; margin-top: 3px; float: right"
			href="javascript:location.replace(location.href);" title="刷新"> 
			<i class="layui-icon" style="line-height: 30px">ဂ</i>
		</a>
	</div>
	<div class="x-body" id="dpt-list">
		<div class="layui-row">
			<form class="layui-form layui-col-md12 x-so">
				<div class="layui-col-xs6">
					<input type="text" id="search_name" name="search_name"
						placeholder="请输入部门名称" autocomplete="off" class="layui-input">
					<input type="text" id="search_manager" name="search_manager"
						placeholder="请输入部门经理" autocomplete="off" class="layui-input">
					<a class="layui-btn" v-on:click="dptSearch">
						<i class="layui-icon">&#xe615;</i>
					</a>
				</div>
			</form>
		</div>
		<xblock>
		<!-- <button class="layui-btn layui-btn-danger" onclick="delAll()">
			<i class="layui-icon"></i>批量删除
		</button> -->
		<a class="layui-btn" v-on:click="dptEdit">
			<i class="layui-icon"></i>添加
		</a>
		<span class="x-right" style="line-height: 40px">共有数据：{{totalNum}} 条</span> </xblock>
		<table class="layui-table">
			<thead>
				<tr>
					<th>
						<div class="layui-unselect header layui-form-checkbox"
							lay-skin="primary">
							<i class="layui-icon">&#xe605;</i>
						</div>
					</th>
					<th>部门名称</th>
					<th>部门描述</th>
					<th>部门电话</th>
					<th>部门经理</th>
					<th>操作</th>
				</tr>
			</thead>
			<tbody>
				<tr v-for="item in dptdata">
					<td>
						<div class="layui-unselect layui-form-checkbox" lay-skin="primary">
							<i class="layui-icon">&#xe605;</i>
						</div>
					</td>
					<td>{{item.name}}</td>
					<td>{{item.memo}}</td>
					<td>{{item.tel}}</td>
					<td>{{item.manager}}</td>
					<td class="td-manage">
						<a title="编辑" v-on:click="dptEdit(item)" href="javascript:;"> 
							<i class="layui-icon">&#xe642;</i>
						</a> 
						<a title="删除" v-on:click="dptDel(item.departmentId)" href="javascript:;"> 
							<i class="layui-icon">&#xe640;</i>
						</a>
					</td>
				</tr>
			</tbody>
		</table>
		<!-- <div class="page">
			<div>
				<a class="prev" href="">&lt;&lt;</a> 
				<a class="num" href="">1</a> 
				<span class="current">2</span> 
				<a class="num" href="">3</a> 
				<a class="num" href="">489</a> 
				<a class="next" href="">&gt;&gt;</a>
			</div>
		</div> -->

		<div id="mask" v-if="editcontent">
			<div class="mask">
				<div class="title">
					部门{{title}} <span @click="editcontent=false"> X </span>
				</div>
				<div id="dpt_eidt" class="x-body">
					<form class="layui-form" id="editfrom">
						<input type="hidden" id="L_departmentId" name="departmentId" v-model="department.departmentId" readonly="readonly" 
									autocomplete="off" class="layui-input">
						<div class="layui-form-item">
							<label for="L_name" class="layui-form-label"> <span class="x-red">*</span>部门名称</label>
							<div class="layui-input-inline">
								<input type="text" id="L_name" name="name" v-model="department.name" lay-verify="name"
									autocomplete="off" class="layui-input">
							</div>
						</div>
						<div class="layui-form-item">
							<label for="L_memo" class="layui-form-label"> <span class="x-red">*</span>部门描述</label>
							<div class="layui-input-inline">
								<input type="text" id="L_memo" name="memo" v-model="department.memo" required="" lay-verify="memo" autocomplete="off" class="layui-input">
							</div>
						</div>
						<div class="layui-form-item">
							<label for="L_tel" class="layui-form-label"> <span
								class="x-red">*</span>部门电话
							</label>
							<div class="layui-input-inline">
								<input type="text" id="L_tel" name="tel" v-model="department.tel" required=""
									lay-verify="phone" autocomplete="off" class="layui-input">
							</div>
						</div>
						<div class="layui-form-item">
							<label for="L_manager" class="layui-form-label"> <span
								class="x-red">*</span>部门经理
							</label>
							<div class="layui-input-inline">
								<input type="text" id="L_manager" name="manager" v-model="department.manager" required=""
									lay-verify="required" autocomplete="off" class="layui-input">
							</div>
						</div>
						<div class="layui-form-item">
							<label for="L_btn" class="layui-form-label"> </label>
							<button class="layui-btn" lay-filter="savedpt" v-on:click="savedpt" lay-submit="">保存</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
</body>
<script>


var vm = new Vue({
	el: '#dpt-list',
	data: {
		dptdata: [],
		totalNum: "",
		department: {},
		title: "",
		saveOrUpdate: "",
		editcontent: false
	},
	created(){
		this.querydptList();
	},
	methods: {
		querydptList(){
			let that = this;
			$.ajax({
				async : false,
				cache : false,
				url : "/human/department/query",
				contentType : "application/json",
				type : "POST",
				data : JSON.stringify({ 'pageIndex': '0', 'pageSize': '10' }),
				dataType : "json",
				success : function(data) {
					if(data.resultCode=='0') {
						that.dptdata = data.departments;
						if(data.departments) {
							that.totalNum = data.departments.length;
						} else {
							that.totalNum = 0;
						}
					} else {
						layer.msg(data.resultMessage);
					}
				},error : function(request) {
					layer.msg('网络错误'); 
		        }
			});
		},
		dptDel: function (id) //删除 
		{
			let that = this;
			$.ajax({
				async : false,
				cache : false,
				url : "/human/department/delete",
				contentType : "application/json",
				type : "POST",
				data : JSON.stringify({ 'departmentId': id}),
				dataType : "json",
				success : function(data) {
					if(data.resultCode=='0') {
						that.querydptList();
					} else {
						layer.msg(data.resultMessage);
					}
				},error : function(request) {
					layer.msg('网络错误'); 
		        }
			});
		},
		dptEdit: function (item) //更新 
		{
			var that = this;
			that.department = {
				departmentId: item.departmentId,
				name: item.name,
				memo: item.memo,
				tel: item.tel,
				manager: item.manager
			}
			if(item.departmentId == '' || item.departmentId == undefined) {
				that.title = "新增";
				that.saveOrUpdate = "save";
			} else {
				that.title = "编辑";
				that.saveOrUpdate = "update";
			}
			that.editcontent = true;
		},
		savedpt: function() {
			var that = this;
			layui.use(['form','layer'], function(){
			    $ = layui.jquery;
			  var form = layui.form;
			  var layer = layui.layer;
			  //自定义验证规则
			  form.verify({
			  	name: function(value){
			      if(value == ''){
			        return '部门名称不能为空';
			      }
			    }
			  });
			  var subFlag = true;
			  //监听提交
			 form.on('submit(savedpt)', function(data){
				 var jsonStr = $('#editfrom').serializeObject(that.saveOrUpdate);
				 var url = "";
				 if(subFlag) {
					 if(that.saveOrUpdate == 'save') {
						 url = "/human/department/add";
					 } else {
						 url = "/human/department/modify";
					 }
				   $.ajax({
						async : false,
						cache : false,
						url : url,
						contentType : "application/json",
						type : "POST",
						data : JSON.stringify(jsonStr),
						dataType : "json",
						success : function(data) {
							if(data.resultCode=='0') {
								layer.msg(that.title + "成功");
								that.querydptList();
							    that.editcontent = false;
							} else {
								layer.msg(data.resultMessage);
							}
						},error : function(request) {
							layer.msg('网络错误'); 
				        }
					});
				 }
				 subFlag = false;
			    return false;
			  });
			});
		},
		// 按条件查询
		dptSearch: function() {
			let that = this;
			$.ajax({
				async : false,
				cache : false,
				url : "/human/department/query",
				contentType : "application/json",
				type : "POST",
				data : JSON.stringify({'departmentName': $("#search_name").val(),'manager': $("#search_manager").val(), 'pageIndex': '0', 'pageSize': '10' }),
				dataType : "json",
				success : function(data) {
					if(data.resultCode=='0') {
						that.dptdata = data.departments;
						if(data.departments) {
							that.totalNum = data.departments.length;
						} else {
							that.totalNum = 0;
						}
						
					} else {
						layer.msg(data.resultMessage);
					}
				},error : function(request) {
					layer.msg('网络错误'); 
		        }
			});
		}
	}  
}); 

$.fn.serializeObject = function(flag) {
    var o = {};
    var dpt = {"department":o};
    var a = this.serializeArray();
    $.each(a, function() {
    	if(flag == "save") {
    		if(this.name == 'departmentId') {
    			return;
    		}
    	}
        if (o[this.name]) {
            if (!o[this.name].push) {
                o[this.name] = [ o[this.name] ];
            }
            o[this.name].push(this.value || '');
        } else {
            o[this.name] = this.value || '';
        }
    });
    return dpt;
}
</script>
</html>